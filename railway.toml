[build]
builder = "NIXPACKS"

[build.nixpacksPlan.phases.setup]
cmds = [
  "npm install -g pnpm@8.15.5"
]

[build.nixpacksPlan.phases.install]
cmds = [
  "pnpm install --frozen-lockfile",
  "cd apps/api && pnpm prisma generate"
]

[build.nixpacksPlan.phases.build]
cmds = [
  "pnpm --filter @musicr/shared build",
  "pnpm --filter @musicr/api build"
]

[deploy]
startCommand = "cd apps/api && node dist/index.js"
healthcheckPath = "/health"
healthcheckTimeout = 300
restartPolicyType = "ON_FAILURE"

[databases.postgres]
database = "musicr"

# Ignore web app during API builds to prevent import-time errors
[build.env]
NIXPACKS_IGNORE_PATHS = "apps/web"
